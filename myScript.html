<!--Tony Lee-->
<!--MAKE SURE POP UP IS NOT BLOCKED-->
<!--USE CHROME BROWSER TO ENSURE NO ERRORS-->

<html>
<head>
</head>

<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"><!--Uses jQuery Library hosted online-->
</script>
   <script language="javascript" type="text/javascript">  
      //This example gets all the items in the Events list, up to 1000 elements  
  
      //This variable will hold a reference to the Events list items collection  
	  
	  var eventList=[];
	  	var eventWant="";
      var returnedItems = null;
	  var returnedItems2 = null;
	  var returnedItems3 = null;
	  var markup;
	  var listItem;
	  var listItem2;
	  var sel;
	  var opt;
	  
	  //variables for ordering of colm
	  //var timeArr=[];
	  //var locationArr=[];
	  
	  //variables for ordering events by time
	  var eventOrder=[];
	  var timeEvent=[];
	  //variables for speaker data to be initiated
	  var speakerList=[];
	  var speakerJob=[];
	  var speakerAdd=[];
	  var speakerCity=[];
	  var speakerState=[];
	  var speakerPhone=[];
	  var speakerFax=[];
	  var speakerEmail=[];
	  var speakerDes=[];
	  var speakerFR=[];
	  var speakerNO=[];
	  var speakerDNO=[];
	  var speakerContact=[];
	  var speakerAgree=[];
	  var speakerCom=[];
	  
	  $(window).load( function() {
			//if (populateEvent()!="Failed")
			//{
				var selectHtml="";
				selectHtml+="";
				updateEvent();
				//document.getElementById("listEvents").innerHTML = "<option selected value='base'>Select Event</option>";
			//}
		});
		
	function querySpeaker()
   {
   	  var context2;
	  var list2;
	  var caml2;
		 //Get the current context  
		 context2 = new SP.ClientContext();  
		 //Get the Sessions list. Alter this code to match the name of your list  
		 list2 = context2.get_web().get_lists().getByTitle('Contacts');  
		 //Create a new CAML query
		 caml2 = new SP.CamlQuery();  
		 caml2.set_viewXml('<View><RowLimit>1000</RowLimit></View>');  
		 //Specify the query and load the list oject  
		 returnedItems2 = list2.getItems(caml2);  
		 context2.load(returnedItems2);  
		 //Run the query asynchronously, passing the functions to call when a response arrives  
		 context2.executeQueryAsync(speakerCallback, onFailedCallback2);
   }
   
   	function speakerCallback(sender, args) 
	{
		//Items returned from the query
        var enumerator2 = returnedItems2.getEnumerator();  
		//counter to keep track of which contact we're on
		var counter=0;
		while (enumerator2.moveNext()) 
		{  
			 listItem2 = enumerator2.get_current();
			 speakerList.push(listItem2.get_item('Title'));
			 //Store each type of data in an array for each contact, grouped by the type of data
			 //For example speakerList[0] would be the name of the first contact, speakerList[1] is name of second contact
			 if (listItem2.get_item('Job_x0020_Title')!=null)
			 {
				speakerJob.push(listItem2.get_item('Job_x0020_Title'));
			 }
			else
			{
				speakerJob.push("None");
			}
			if(listItem2.get_item('Street_x0020_Address')!=null)
			{
				speakerAdd.push(listItem2.get_item('Street_x0020_Address'));
			}
			else
			{
				speakerAdd.push("None");
			}
			if(listItem2.get_item('City')!=null)
			{
				speakerCity.push(listItem2.get_item('City'));
			}
			else
			{
				speakerCity.push("None");
			}
			if(listItem2.get_item('State')!=null)
			{
				speakerState.push(listItem2.get_item('State'));
			}
			else
			{
				speakerState.push("None");
			}
			if(listItem2.get_item('Phone')!=null)
			{
				speakerPhone.push(listItem2.get_item('Phone'));
			}
			else
			{
				speakerPhone.push("None");
			}
			if(listItem2.get_item('Fax')!=null)
			{
				speakerFax.push(listItem2.get_item('Fax'));
			}
			else
			{
				speakerFax.push("None");
			}
			if(listItem2.get_item('E_x002d_Mail_x0020_Address')!=null)
			{
				speakerEmail.push(listItem2.get_item('E_x002d_Mail_x0020_Address'));
			}
			else
			{
				speakerEmail.push("None");
			}
			if(listItem2.get_item('Designations')!=null)
			{
				speakerDes.push(listItem2.get_item('Designations'));
			}
			else
			{
				speakerDes.push("None");
			}
			if(listItem2.get_item('FR_x0020_Number')!=null)
			{
				speakerFR.push(listItem2.get_item('FR_x0020_Number'));
			}
			else
			{
				speakerFR.push("None");
			}
			if(listItem2.get_item('NO_x0020_Number')!=null)
			{
				speakerNO.push(listItem2.get_item('NO_x0020_Number'));
			}
			else
			{
				speakerNO.push("None");
			}
			if(listItem2.get_item('DNO_x0020_Number')!=null)
			{
				speakerDNO.push(listItem2.get_item('DNO_x0020_Number'));
			}
			else
			{
				speakerDNO.push("None");
			}
			if(listItem2.get_item('Contact_x0020_Type')!=null)
			{
				speakerContact.push(listItem2.get_item('Contact_x0020_Type'));
			}
			else
			{
				speakerContact.push("None");
			}
			if(listItem2.get_item('Speaker_x0020_agreement')!=null)
			{
				speakerAgree.push(listItem2.get_item('Speaker_x0020_agreement'));
			}
			else
			{
				speakerAgree.push("None");
			}	
			if(listItem2.get_item('Speaker_x0020_Compliance')!=null)
			{
				speakerCom.push(listItem2.get_item('Speaker_x0020_Compliance'));
			}
			else
			{
				speakerCom.push("None");
			}	
			 counter++;//increment counter to move onto next contact
		}
	}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      //This function loads the list and runs the query asynchronously  
      function queryListItems() { 
		var yourSelect = document.getElementById( "listEvents" );	
		//Check if user has selected an event to generate report
		eventWant=yourSelect.options[ yourSelect.selectedIndex ].value;
		 if ((eventWant=="base")==true)
		 {
			alert('Please Select an Event');
		 }
		 //Continue if user has selected an option
		 else
		 {
			var context;
			var list;
			var caml;

			 //Get the current context  
			 context = new SP.ClientContext();  
			 //Get the Sessions list. Alter this code to match the name of your list  
			 list = context.get_web().get_lists().getByTitle('Sessions');  
			 //Create a new CAML query
			 caml = new SP.CamlQuery();  
			 caml.set_viewXml('<View><RowLimit>1000</RowLimit></View>');  
			 //Specify the query and load the list oject  
			 returnedItems = list.getItems(caml);  
			 context.load(returnedItems);  
			 //Run the query asynchronously, passing the functions to call when a response arrives  
			 context.executeQueryAsync(onSucceededCallback, onFailedCallback);  
		 }
      }  
  
      //This function fires when the query completes successfully  
      function onSucceededCallback(sender, args) {  
         //Get an enumerator for the items in the list 
		var enumerator;
         enumerator = returnedItems.getEnumerator();  
         //Formulate HTML from the list items  
		 //Writing the title and styling the table
         markup = "<style>table, th, td{border: 1px solid black;}</style><title>Report</title><h3><center>2016 Annual Meeting of the Association of Network"+
		 " Representatives</center></h3><table style='width:100%'><tr><td>Time</td>"+
		 "<td>Location - Room</td><td>Session</td><td>Speakers</td></tr>";  
         //Loop through all the items  
		 var order=0;
        while (enumerator.moveNext()) 
		{  
			eventOrder[order]="";
			 listItem = enumerator.get_current();
			var eventName=(listItem.get_item('Event')).get_lookupValue(); 
			//gets the name of the event this session belongs to
				
			 //Only include session if publish is set to true
			 if (listItem.get_item('Publish')&&(eventName==eventWant)) //Execute code if publish is true and session in event we want to query
			 {				
				var num=((listItem.get_item('Start_x0020_DateTime')).getHours());
				//num gets the hour of the start time
				var num2=(listItem.get_item('Start_x0020_DateTime')).getMinutes();
				//num2 get the minute of the start time
				
				timeEvent[order]=num;
				timeEvent[order]+=num2*1.0/60;
				
				if (num.toString().length==1) {num="0"+String(num);}
				else {num=String(num);}
				//adds a 0 to the string num if it has 1 digit
				
				if (num2.toString().length==1) {num2="0"+String(num2);}
				else {num2=String(num2);}
				//adds a 0 to the string num2 if it has 1 digit
				
				var timeStart=num+":"+num2;
				//make the timeStart string to represent start time
				
				var num3=((listItem.get_item('End_x0020_DateTime')).getHours());
				//num3 gets the hour of the end time
				var num4=(listItem.get_item('End_x0020_DateTime')).getMinutes();
				//num4 gets the minute of the end time
				
				if (num3.toString().length==1) {num3="0"+String(num3);}
				else {num3=String(num3);}
				//adds a 0 to the string num3 if it has 1 digit
				
				if (num4.toString().length==1) {num4="0"+String(num4);}
				else {num4=String(num4);}
				//adds a 0 to the string num4 if it has 1 digit

				var timeEnd=num3+":"+num4;
				//make the timeend string to represent end time
				
				eventOrder[order] += "<tr><td>"+String(timeStart)+" - "+String(timeEnd)+"</td>";
				//add the variables to the html display
				
				var roomName=listItem.get_item('Room_x0020_Name');
				if (roomName!=null)
				{
					//Do nothing
				}
				else
				{
					roomName="None";//set room name to none
				}
				
				var roomLocation=listItem.get_item('Room_x0020_Location');
				if (roomLocation!=null)
				{
					eventOrder[order]+="<td>"+listItem.get_item('Room_x0020_Location')+" - "+roomName+"</td>";//Gets the location of the room of the session
				}
				else
				{
					eventOrder[order]+="<td>None - "+roomName+"</td>";//set location to none
				}
				
				eventOrder[order]+="<td>"+listItem.get_item('Title')+"</td>";
				//markup += 'Session: ' + listItem.get_item('Title') + '<br>';//Gets the session name
				
				var count=0;
				var displayStr="";
				while(listItem.get_item('Speakers')[count]!=undefined)
				{
					var tempStr=(listItem.get_item('Speakers')[count]).get_lookupValue();
					if (count!=0)
					{
						//add a line break if not the first speaker
						displayStr+="<br>"
					}
					displayStr+=tempStr;
					
					//Get contact value and add to markup
					//querySpeaker();
					var speakerNum=-1;
					for(var i=0;i<speakerList.length;i++)
					{
						//find the index of the speaker stored in the array
						if(speakerList[i]==tempStr)
						{
							speakerNum=i;
							break;
						}
					}
					//display all the data for a specific speaker
					displayStr+=", Job: "+speakerJob[speakerNum]+"<br>";
					displayStr+="Address: "+speakerAdd[speakerNum]+"<br>";
					displayStr+="City: "+speakerCity[speakerNum]+"<br>";
					displayStr+="State: "+speakerState[speakerNum]+"<br>";
					displayStr+="Phone: "+speakerPhone[speakerNum]+"<br>";
					displayStr+="Fax: "+speakerFax[speakerNum]+"<br>";
					displayStr+="Email: "+speakerEmail[speakerNum]+"<br>";
					displayStr+="Designations: "+speakerDes[speakerNum]+"<br>";
					displayStr+="FR: "+speakerFR[speakerNum]+"<br>";
					displayStr+="NO: "+speakerNO[speakerNum]+"<br>";
					displayStr+="DNO: "+speakerDNO[speakerNum]+"<br>";
					displayStr+="Contact Type: "+speakerContact[speakerNum]+"<br>";
					displayStr+="Agreement: "+speakerAgree[speakerNum]+"<br>";
					displayStr+="Compliance: "+speakerCom[speakerNum]+"<br>";
					//ADD IN OTHER ATTRIBUTES
					count++; //Increment count until there are no more contacts
				}
				eventOrder[order]+="<td>"+displayStr+"</td></tr>"
				
				eventOrder[order] += 'Source: ' + listItem.get_item('Source') + '<br>';//Gets the source for session
				//Whether this is a group session
				var check="";
				if (listItem.get_item('Group_x0020_Session')==true)
				{
					check="Yes"
				}
				else
				{
					check="No"
				}
				
				eventOrder[order] += 'Group Session: ' + check+'<br>';//Gets whether it is a group session
				
				//var num=((listItem.get_item('Start_x0020_DateTime')).getDay());
				//var num=((listItem.get_item('Start_x0020_DateTime')).getMonth()+1);
				//var num=((listItem.get_item('Start_x0020_DateTime')).getFullYear());
				//var num=((listItem.get_item('End_x0020_DateTime')).getDay());
				//var num=((listItem.get_item('End_x0020_DateTime')).getMonth()+1);
				//var num=((listItem.get_item('End_x0020_DateTime')).getFullYear());					
			 }
			 order++;//add one to the variable in order to organize the events based on start time
		}	
		
		//Selection sort O(n^2) in terms of start time, can be improved for large data sets
		for(var a=0;a<timeEvent.length-1;a++)
		{
			for(var b=a+1;b<timeEvent.length;b++)
			{
				if (timeEvent[a]>timeEvent[b])
				{
					var temp=eventOrder[a];
					eventOrder[a]=eventOrder[b];
					eventOrder[b]=temp;
				}
			}
		}
		//Add each html element in the sorted array into the document to be displayed
		for(var i=0;i<eventOrder.length;i++)
		{
			markup+=eventOrder[i];
		}
	  //open new window, MAKE SURE POP UP WINDOW IS NOT BLOCKED
		newwindow=window.open();
		newdocument=newwindow.document;
		newdocument.write(markup);
		newdocument.close();
   }  
   
   //This function fires when the query fails  
   function onFailedCallback(sender, args) {  
      //Display the details  
	  alert('Query failed');
   }  
    function onFailedCallback2(sender, args) {  
      //Display the details  
	  alert('Query failed');
   }  
   function onFailedCallback3(sender, args) {  
      //Display the details  
	  alert('Query failed');
   }  
  
	function updateEvent()
   {
   	  var context3;
	  var list3;
	  var caml3;
		 //Get the current context  
		 context3 = new SP.ClientContext();  
		 //Get the Sessions list. Alter this code to match the name of your list  
		 list3 = context3.get_web().get_lists().getByTitle('Events');  
		 //Create a new CAML query
		 caml3 = new SP.CamlQuery();  
		 caml3.set_viewXml('<View><RowLimit>1000</RowLimit></View>');  
		 //Specify the query and load the list oject  
		 returnedItems3 = list3.getItems(caml3);  
		 context3.load(returnedItems3);  
		 //Run the query asynchronously, passing the functions to call when a response arrives  
		 context3.executeQueryAsync(eventCallback, onFailedCallback3);
   }
	   
	function eventCallback(sender, args) 
	{ 

		alert('success');
	/*
        //Get an enumerator for the items in the list  
        enumerator = returnedItems.getEnumerator();  
        //Loop through all the items
        //while (enumerator.moveNext()) 
		//{
		//	listItem = enumerator.get_current();
		//	eventList.push(listItem.get_item('Title'));			
		//}
			// get reference to select element
			sel = document.getElementById('listEvents');

			// create new option element
			opt = document.createElement('option');
		
			// create text node to add to option element (opt)
			opt.appendChild( document.createTextNode('New Option Textfdsafdsafdsafadsfafffffffffffffffffffffff') );

			// set value property of opt
			opt.value = 'option value';

			// add opt to end of select box (sel)
			sel.appendChild(opt);
			alert('wow2');*/
	}
	function callFunction()
	{
		querySpeaker ();
		queryListItems ();
	}

		
</script>  

<!-- Drop down list based on events available, move all to load location? -->
<!-- Make it easier to swap columns, have variable on top -->
<!-- Add in Date of Report Filing -->
<!-- Improve selection sort-->

<body>
<select id="listEvents">
	<option value='base'>Select Event</option>"
   <option value="Annual Meeting">Annual Meeting</option>
  <option value="Event 1">Event 1</option> 
  <option value="Event 2">Event 2</option>
</select>
<div><button id="updateButton" onclick=" updateEvent()">Update Events</button></div>
<br><br>
<div><button id="queryButton" onclick=" callFunction()">Create Report</button></div><!--Button calls queryListItems() when clicked-->
</body>
</html>