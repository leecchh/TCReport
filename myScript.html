<!--Tony Lee-->
<!--MAKE SURE POP UP IS NOT BLOCKED-->
<!--USE CHROME BROWSER TO ENSURE NO ERRORS-->

<html>
<head>
</head>

<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"><!--Uses jQuery Library hosted online-->
</script>
   <script language="javascript" type="text/javascript">  
      //This example gets all the items in the Events list, up to 1000 elements  
  
      //This variable will hold a reference to the Events list items collection  
	  
	  var eventList=[];
	  	var eventWant="";
      var returnedItems = null;
	  var context;
	  var list;
	  var caml;
	  var enumerator;
	  var markup;
	  var listItem;
	  var sel;
	  var opt;
	  
	  
	  $(window).load( function() {
			//if (populateEvent()!="Failed")
			//{
				var selectHtml="";
				selectHtml+="";
				//alert('wow');
				//populateEvent();
				//alert(eventList[0]);
				//document.getElementById("listEvents").innerHTML = "<option selected value='base'>Select Event</option>";
			//}
		});
  
      //This function loads the list and runs the query asynchronously  
      function queryListItems() { 
		var yourSelect = document.getElementById( "listEvents" );	
		//Check if user has selected an event to generate report
		eventWant=yourSelect.options[ yourSelect.selectedIndex ].value;
		 if ((eventWant=="base")==true)
		 {
			alert('Please Select an Event');
		 }
		 //Continue if user has selected an option
		 else
		 {
			 //Get the current context  
			 context = new SP.ClientContext();  
			 //Get the Sessions list. Alter this code to match the name of your list  
			 list = context.get_web().get_lists().getByTitle('Sessions');  
			 //Create a new CAML query
			 caml = new SP.CamlQuery();  
			 caml.set_viewXml('<View><RowLimit>1000</RowLimit></View>');  
			 //Specify the query and load the list oject  
			 returnedItems = list.getItems(caml);  
			 context.load(returnedItems);  
			 //Run the query asynchronously, passing the functions to call when a response arrives  
			 context.executeQueryAsync(onSucceededCallback, onFailedCallback);  
		 }
      }  
  
      //This function fires when the query completes successfully  
      function onSucceededCallback(sender, args) {  
         //Get an enumerator for the items in the list 
			//alert(eventWant);
         enumerator = returnedItems.getEnumerator();  
         //Formulate HTML from the list items  
		 //Writing the title and styling the table
         markup = "<style>table, th, td{border: 1px solid black;}</style><title>Report</title><h3><center>2016 Annual Meeting of the Association of Network"+
		 " Representatives</center></h3><table style='width:100%'><tr><td>Time</td>"+
		 "<td>Location - Room</td><td>Session</td><td>Speakers</td></tr>";  
         //Loop through all the items  
        while (enumerator.moveNext()) 
		{  
			 listItem = enumerator.get_current();
			 
			 //Only include session if publish is set to true
			var eventName=JSON.stringify(listItem.get_item('Event')); //Turns the event object to string
			var arr = eventName.split("");
			var i=18;
			var str="";
			//parsing the eventName string below, method may have to be modified based on JSON.stringify output
			while (i<arr.length-2)
			{
				str+=arr[i];
				i++;
			}
			//markup += 'Event: ' + str + '<br><br>'; //What event session belongs to
				
			 if (listItem.get_item('Publish')&&(str==eventWant)) //Execute code if publish is true and session in event we want
			 {				
				var num=((listItem.get_item('Start_x0020_DateTime')).getUTCHours()-(listItem.get_item('Start_x0020_DateTime')).getTimezoneOffset()/60);
				if (num<0) {num+=24;}
				var num2=(listItem.get_item('Start_x0020_DateTime')).getMinutes();
				
				if (num.toString().length==1) {num="0"+String(num);}
				else {num=String(num);}
				
				if (num2.toString().length==1) {num2="0"+String(num2);}
				else {num2=String(num2);}
				
				var timeStart=num+":"+num2;
				
				
				var num=((listItem.get_item('End_x0020_DateTime')).getUTCHours()-(listItem.get_item('End_x0020_DateTime')).getTimezoneOffset()/60);
				if (num<0) {num+=24;}
				var num2=(listItem.get_item('End_x0020_DateTime')).getMinutes();
				
				if (num.toString().length==1) {num="0"+String(num);}
				else {num=String(num);}
				
				if (num2.toString().length==1) {num2="0"+String(num2);}
				else {num2=String(num2);}

				var timeEnd=num+":"+num2;
				
				markup += "<tr><td>"+String(timeStart)+" - "+String(timeEnd)+"</td>";
				//markup += 'Start Time: ' +startStr + '<br>';//Start time for the session
				
				var roomName=listItem.get_item('Room_x0020_Name');
				if (roomName!=null)
				{
					//Do nothing
				}
				else
				{
					roomName="None";//set room name to none
				}
				
				var roomLocation=listItem.get_item('Room_x0020_Location');
				if (roomLocation!=null)
				{
					markup+="<td>"+listItem.get_item('Room_x0020_Location')+" - "+roomName+"</td>";//Gets the location of the room of the session
				}
				else
				{
					markup+="<td>None - "+roomName+"</td>";//set location to none
				}
				
				markup+="<td>"+listItem.get_item('Title')+"</td>";
				//markup += 'Session: ' + listItem.get_item('Title') + '<br>';//Gets the session name
				
				var contactName=JSON.stringify(listItem.get_item('Speakers')); //Turns the event object to string
				
				var arr2 = contactName.split("");
				var i=19;
				var str2="";
				//parsing the contactName string below, method may have to be modified based on JSON.stringify output
				while (i<arr2.length-3)
				{
					str2+=arr2[i];
					if (arr2[i+3]==',')
					{
						str2+=", ";
						i=i+21;
					}
					i++;
				}
				
				markup+="<td>"+str2+"</td></tr>"
				//markup += 'Contacts: ' + str2 + '<br>';
				
				markup += 'Source: ' + listItem.get_item('Source') + '<br>';//Gets the source for session
				//Whether this is a group session
				var check="";
				if (listItem.get_item('Group_x0020_Session')==true)
				{
					check="Yes"
				}
				else
				{
					check="No"
				}
				
				markup += 'Group Session: ' + check+'<br>';//Gets whether it is a group session
				
				//var num=((listItem.get_item('Start_x0020_DateTime')).getDay());
				//var num=((listItem.get_item('Start_x0020_DateTime')).getMonth()+1);
				//var num=((listItem.get_item('Start_x0020_DateTime')).getFullYear());
				//var num=((listItem.get_item('End_x0020_DateTime')).getDay());
				//var num=((listItem.get_item('End_x0020_DateTime')).getMonth()+1);
				//var num=((listItem.get_item('End_x0020_DateTime')).getFullYear());
				var startStr="";
				markup += 'Start Date: ' + startStr + '<br>';//Start date for the session
				
				var endStr="";
				markup += 'End Date: ' + endStr + '<br><br>';//End time for the session
				
				
				//markup += 'Item ID: ' + listItem.get_id() + '<br>';  			
			 }
		}  
	  //open new window, MAKE SURE POP UP WINDOW IS NOT BLOCKED
		newwindow=window.open();
		newdocument=newwindow.document;
		newdocument.write(markup);
		newdocument.close();
   }  
   
   //This function fires when the query fails  
   function onFailedCallback(sender, args) {  
      //Formulate HTML to display details of the error  
      markup = '<p>The request failed: <br>';  
      markup += 'Message: ' + args.get_message() + '<br>';  
      //Display the details  
   }  
   
   /*
     function onFailedCallback2(sender, args) {  
      //Formulate HTML to display details of the error  
      markup = '<p>The request failed: <br>';  
      markup += 'Message: ' + args.get_message() + '<br>';  
      //Display the details 
   }  
   
    function populateEvent() 
	{
		 //Get the current context  
		alert('wow');
		 context = SP.ClientContext();  
		 //Get the Sessions list. Alter this code to match the name of your list  
		 list = context.get_web().get_lists().getByTitle('Events');  
		 //Create a new CAML query
		 caml = SP.CamlQuery();  
		 caml.set_viewXml('<View><RowLimit>1000</RowLimit></View>');  
		 //Specify the query and load the list oject  
		 returnedItems = list.getItems(caml);  
		 alert(JSON.stringify(returnedItems));
		 context.load(returnedItems);  
		 //Run the query asynchronously, passing the functions to call when a response arrives  
		 context.executeQueryAsync(onSucceededCallback2, onFailedCallback2);  
    }  
	
	function onSucceededCallback2(sender, args) 
	{  
        //Get an enumerator for the items in the list  
        enumerator = returnedItems.getEnumerator();  
        //Loop through all the items
        //while (enumerator.moveNext()) 
		//{
		//	listItem = enumerator.get_current();
		//	eventList.push(listItem.get_item('Title'));			
		//}
			// get reference to select element
			sel = document.getElementById('listEvents');

			// create new option element
			opt = document.createElement('option');
		
			// create text node to add to option element (opt)
			opt.appendChild( document.createTextNode('New Option Textfdsafdsafdsafadsfafffffffffffffffffffffff') );

			// set value property of opt
			opt.value = 'option value';

			// add opt to end of select box (sel)
			sel.appendChild(opt);
			alert('wow2');
	}*/
</script>  

<!-- Comments-->
<!-- Make Date compatible across Browsers, Event object too if possible -->
<!-- Organize Table according to start time-->
<!-- Modify new page for better UI -->
<!-- OP1 Drop down list based on events available (fix bug in populate event), move all to load location? -->
<!-- OP2 Add in Date of Report Filing -->

<body>
<select id="listEvents">
	<option value='base'>Select Event</option>"
   <option value="Annual Meeting">Annual Meeting</option>
  <option value="Event 1">Event 1</option> 
  <option value="Event 2">Event 2</option>
</select>
<div><button id="updateButton" onclick=" populateEvent ()">Update Events</button></div>
<br><br>
<div><button id="queryButton" onclick=" queryListItems ()">Create Report</button></div><!--Button calls queryListItems() when clicked-->
</body>
</html>